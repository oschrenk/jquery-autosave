/**
 * @fileOverview jQuery.autosave
 *
 * @author Kyle Florence
 * @website https://github.com/kflorence/jquery-autosave
 * @version 1.0.0
 *
 * Inspired by the jQuery.autosave plugin written by Raymond Julin,
 * Mads Erik Forberg and Simen Graaten.
 *
 * Dual licensed under the MIT and BSD Licenses.
 */
(function(c,e){var d=function(i,g,k){var h=c(i),f=/^(checked|selectedIndex)$/,j=("onpropertychange" in document.body);if(!h.length||typeof g!=="string"){return h}if(g!=="change"){return h.bind(g,k)}h.each(function(){g=j&&(this.type==="checkbox"||this.tagName.toLowerCase()==="select"&&this.multiple)?"propertychange":"change";c(this).bind(g,function(l){if(l.type!=="propertychange"||f.test(window.event.propertyName)){k.call(this,l)}})})};var a=function(i,g){var f={},h=typeof i;if(h==="function"){f.method=i}else{if(h==="string"&&i in g){f=g[i]}else{if(h==="object"){h=typeof i.method;if(h==="function"){f=i}else{if(h==="string"&&i.method in g){f=g[i.method]}}if(typeof f.options==="object"){f.options=c.extend(true,{},f.options,i.options)}else{f.options={}}}}}return f};c.autosave={timer:0,$queues:c({}),options:{namespace:"autosave",callbacks:{trigger:"change",scope:null,data:null,condition:null,save:"ajax"},events:{save:"save",saved:"saved",changed:"changed"},classes:{changed:"changed",ignore:"ignore"}},initialize:function(j,g){var f=this;c.extend(this,{context:j.context||document,selector:j.selector||j,options:c.extend(true,{},this.options,g)});if(this.elements().length){var i,k=this.forms(),h=this.inputs();k.data("autosave",this);c.each(this.options.events,function(m,l){f.options.events[m]=[l,f.options.namespace].join(".")});c.each(this.options.classes,function(l,m){f.options.classes[l]=[f.options.namespace,m].join("-")});c.each(this.options.callbacks,function(l,m){i=[];if(m){c.each(c.isArray(m)?m:[m],function(n,o){o=a(o,f.callbacks[l]);if(c.isFunction(o.method)){i.push(o)}})}f.options.callbacks[l]=i});d(k,this.options.events.save,function(l){f.save(this,l.type)});d(h,"change",function(l){c(this).addClass(f.options.classes.changed);c(this.form).triggerHandler(f.options.events.changed,[this])});c.each(this.options.callbacks.trigger,function(m,l){l.method.call(f,l.options)})}return j},elements:function(f,g){f=f||this.selector;g=g||this.context;return c(f,g).filter(function(){return(this.elements||this.form)})},forms:function(f){return c(c.unique(this.elements(f).map(function(){return this.elements?this:this.form}).get()))},inputs:function(f){return this.elements(f).map(function(){return this.elements?c.makeArray(this.elements):this})},validInputs:function(f){var g=this;return this.inputs(f).filter(function(){return !c(this).hasClass(g.options.classes.ignore)})},changedInputs:function(f){var g=this;return this.inputs(f).filter(function(){return c(this).hasClass(g.options.classes.changed)})},startInterval:function(g){var f=this;g=g||this.interval;if(this.timer){this.stopInterval()}if(!isNaN(parseInt(g))){this.timer=setTimeout(function(){f.save(false,f.timer)},g)}},stopInterval:function(){clearTimeout(this.timer);this.timer=null},save:function(f,h){var g=this,k=false,i=this.validInputs(f);if(this.options.callbacks.save.length){c.each(this.options.callbacks.scope,function(m,n){i=n.method.call(g,n.options,i)});if(i.length){var j=true,l=i.serializeArray();c.each(this.options.callbacks.data,function(m,n){l=n.method.call(g,n.options,i,l)});c.each(this.options.callbacks.condition,function(m,n){return(j=n.method.call(g,n.options,i,l,h))!==false});if(j){c.each(this.options.callbacks.save,function(m,n){g.$queues.queue("save",function(){if(n.method.call(g,n.options,l)!==false){g.next("save")}})});k=true}}}this.next("save",k)},next:function(h,g){var f=this.$queues.queue(h);if(f&&f.length){this.$queues.dequeue(h)}else{this.finished(f,h,g)}},finished:function(f,h,g){if(h==="save"){if(f){this.forms().triggerHandler(this.options.events.saved)}if(g!==false){this.changedInputs().removeClass(this.options.classes.changed)}if(this.timer){this.startInterval()}}}};var b=c.autosave.callbacks={};c.each(c.autosave.options.callbacks,function(f){b[f]={}});c.extend(b.trigger,{change:{method:function(){var f=this;this.forms().bind(this.options.events.changed,function(h,g){f.save(g,h.type)})}},interval:{method:function(f){if(!isNaN(parseInt(f.interval))){this.startInterval(this.interval=f.interval)}},options:{interval:30000}}});c.extend(b.scope,{all:{method:function(){return this.validInputs()}},changed:{method:function(){return this.changedInputs()}}});c.extend(b.data,{serializeObject:{method:function(f,g){var h={};c.each(g.serializeArray(),function(k,l){var m=l.name,j=l.value;h[m]=h[m]===e?j:c.isArray(h[m])?h[m].concat(j):[h[m],j]});return h}}});c.extend(b.condition,{interval:{method:function(g,h,i,f){return(!this.timer||this.timer===f)}},changed:{method:function(){return this.changedInputs().length>0}}});c.extend(b.save,{ajax:{method:function(g,h){var f=this;c.ajax(c.extend(true,{data:h},g,{complete:function(j,i){if(c.isFunction(g.complete)){g.complete.apply(f,arguments)}f.next("save")}}));return false},options:{url:window.location.href,type:"PUT"}}});c.fn.autosave=function(f){return c.extend({},c.autosave).initialize(this,f)}})(jQuery);
